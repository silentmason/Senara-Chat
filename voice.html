<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Voice Chat</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.ably.com/ably.min.js"></script>
</head>
<body>
    <h1>Live Voice Chat</h1>

    <div>
        <h2>Your Audio</h2>
        <audio id="localAudio" autoplay muted></audio>
    </div>

    <div>
        <h2>Remote Audio</h2>
        <audio id="remoteAudio" autoplay controls></audio>
    </div>

    <script>
        const ably = new Ably.Realtime({ key: 'XRHh7Q.QGrriA:3QlMEmxAp2POdgbMdec3-6pV1R3QOJ82wGLsRE4tDLU' }); // Replace with your API key
        const channel = ably.channels.get('voice-channel');

        const localAudio = document.getElementById('localAudio');
        const remoteAudio = document.getElementById('remoteAudio');

        let peerConnection;

        async function startWebRTC() {
            const configuration = {
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            };

            peerConnection = new RTCPeerConnection(configuration);

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    channel.publish('ice-candidate', { candidate: event.candidate });
                }
            };

            peerConnection.ontrack = event => {
                remoteAudio.srcObject = event.streams[0];
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                localAudio.srcObject = stream;
                stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
            } catch (error) {
                console.error('Error accessing media devices:', error);
            }

            channel.subscribe('ice-candidate', message => {
                peerConnection.addIceCandidate(message.data.candidate);
            });

            channel.subscribe('offer', message => {
                peerConnection.setRemoteDescription(new RTCSessionDescription(message.data.sdp))
                    .then(() => peerConnection.createAnswer())
                    .then(answer => peerConnection.setLocalDescription(answer))
                    .then(() => {
                        channel.publish('answer', { sdp: peerConnection.localDescription });
                    });
            });

            channel.subscribe('answer', message => {
                peerConnection.setRemoteDescription(new RTCSessionDescription(message.data.sdp));
            });

            if (isCaller()) {
                peerConnection.createOffer()
                    .then(offer => peerConnection.setLocalDescription(offer))
                    .then(() => {
                        channel.publish('offer', { sdp: peerConnection.localDescription });
                    });
            }
        }

        function isCaller() {
            return Math.random() < 0.5;
        }

        startWebRTC();
    </script>
</body>
</html>